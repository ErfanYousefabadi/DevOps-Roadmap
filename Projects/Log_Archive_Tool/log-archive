#!/usr/bin/env bash

verbose=false
output_dir="./archives"

try_help () {
  printf "Try 'log-archive --help' for more information.\n" >&2
}

hlp () {
  cat << EOF
Usage: log-archive [OPTIONS] log_dir

  Archive a log directory into a .tar.gz file.

  Options:
    -o, --output DIR   Directory to write the archive (default: ./archives)
    -v, --verbose      Show tar output
    -h, --help         Show this help and exit
  Examples:
    log-archive /var/log
    log-archive -o ./archives /var/log
    log-archive --verbose /var/log
EOF
}

while [[ $# -gt 0 ]]; do
  case "$1" in 
    -o|--output)
      if [[ -z "$2" || $2 = -* ]] ; then
        echo "log-archive: option '-o' requires an argument" >&2
        try_help
        exit 1
      fi
      output_dir="$2"
      shift 2 ;;
    -v|--verbose)
      verbose=true
      shift ;;
    -h|--help)
      hlp
      exit 0 ;;
    --)
      shift
      break ;;
    -*)
      printf "log-archive: unknown option: '%s'\n" "$1" >&2
      try_help
      exit 1 ;;
    *)
      break ;;
  esac
done

if [[ -z $1 ]]; then
  printf "log-archive: missing log_dir\n" >&2
  try_help
  exit 1
elif [[ -n $2 ]]; then
  printf "log-archive: too many arguments\n" >&2
  try_help
  exit 1
fi

log_dir=$1

if ! [[ -d "$log_dir" ]] ; then
  echo "log-archive: '$log_dir' is not a directory" >&2
  exit 1
elif ! [[ -r "$log_dir" ]] ; then
  echo "log-archive: cannot read '$log_dir'" >&2
  exit 1
fi

if [[ -d "$output_dir" && ! -w "$output_dir" ]] ; then
  echo "log-archive: cannot write to '$output_dir'" >&2
  exit 1
elif ! [[ -d "$output_dir" ]] ; then
  if ! mkdir -p "$output_dir"; then
    echo "log-archive: cannot create '$output_dir'" >&2
    exit 1
  fi
fi

archive_path="$output_dir/logs_archive_$(date "+%Y%m%d_%H%M%S").tar.gz"

if [[ $verbose = false ]] ; then
  tar -C "$log_dir" -czf "$archive_path" -- .
else
  tar -C "$log_dir" -czvf "$archive_path" -- .
fi
